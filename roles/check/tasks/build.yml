---
- name: create template folder
  file: path={{ mktemp.stdout }}/templates state=directory

- name: create sequence number list
  set_fact:
    numb_list: "{{ (numb_list | default([])) + [item] }}"
  with_sequence: "start=0 count=10"

- name: create pod list
  set_fact:
    pods: "{{ (pods | default([])) + [pod_template] }}"
  with_nested:
    - "{{ numb_list }}"
    - [ { svc: "http" } ]

- name: create pvs
  shell: |
    oc create --config={{ mktemp.stdout }}/admin.kubeconfig -f - <<PV
    apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: pv01
    spec:
      accessModes:
      - ReadWriteOnce
      - ReadWriteMany
      - ReadOnlyMany
      capacity:
        storage: 1Gi
      hostPath:
        path: /var/lib/ocp_storage/pv/pv01
      persistentVolumeReclaimPolicy: Recycle
    PV
    done
  args:
    executable: /bin/bash

- name: copy build templates
  template:
    src: "{{ item.src }}"
    dest: "{{ mktemp.stdout }}/templates/{{ item.dest }}"
    mode: 0777
  with_items:
    - { src: 'busybox.j2', dest: 'busybox.yml' }
    - { src: 'hello-openshift.j2', dest: 'hello-openshift.yml' }

- name: create test project
  command: oc new-project test --config={{ mktemp.stdout }}/admin.kubeconfig
  register: new_project
  failed_when: ('already exists' not in new_project.stderr) and ('Now using project' not in new_project.stdout)

- name: deploy hello openshift pods
  command: oc create -f {{ mktemp.stdout }}/templates/hello-openshift.yml -n test --config={{ mktemp.stdout }}/admin.kubeconfig
  register: deploy_hello
  failed_when: ('already exists' not in deploy_hello.stderr) and ('created' not in deploy_hello.stdout)
  changed_when: ('created' in deploy_hello.stdout)

- name: deploy busybox pod
  command: oc create -f {{ mktemp.stdout }}/templates/busybox.yml -n test --config={{ mktemp.stdout }}/admin.kubeconfig
  register: deploy_busy
  failed_when: ('already exists' not in deploy_busy.stderr) and ('created' not in deploy_busy.stdout)
  changed_when: ('created' in deploy_busy.stdout)

- name: check if all pods are running
  shell: oc get pods -l app={{ item.name }} -n test --config={{ mktemp.stdout }}/admin.kubeconfig | tail -n1 | awk '{ print $3 }' | tail -n1
  register: check
  until: check.stdout.find("Running") != -1
  with_items:
    - "{{ pods }}"
    - busybox
  retries: 10
  delay: 20

- name: get busybox pod name
  shell: c get pods -l app=busybox -n test --config={{ mktemp.stdout }}/admin.kubeconfig | awk '{ print $1 }' | tail -n1
  register: busybox_pod

- name: get hello openshift pod hostnames
  command: oc get route -n test -o json --config={{ mktemp.stdout }}/admin.kubeconfig
  register: check_route

- name: convert check_route string to json
  set_fact: check_route_json="{{ check_route.stdout | from_json }}"

- name: set query to get pod hostname
  set_fact:
    hostname_query: "items[*].spec.host"

- name: get hostname list
  set_fact:
    pod_hostnames: "{{ check_route_json | json_query(hostname_query) }}"

- name: connect to route via curl
  command: "curl -v http://{{ item }}/"
  with_items: "{{ pod_hostnames }}"
  register: check_http_route

- name: set json query
  set_fact:
    route_query: "[*].stdout"

- name: show route http response
  debug:
    msg: "{{ check_http_route.results | json_query(route_query) }}"

- name: trigger new build
  command: oc start-build hello-build -n test --config={{ mktemp.stdout }}/admin.kubeconfig
  register: build
  failed_when: ('started' not in build.stdout)
  changed_when: ('started' in build.stdout)

- name: check new build is created
  shell: oc get build --config={{ mktemp.stdout }}/admin.kubeconfig | tail -n1 | awk '{ print $1 }' | tail -n1
  register: build_check
  failed_when: ('hello-build-2' not in build_check.stdout)
  changed_when: ('hello-build-2' in build_check.stdout)

- name: check if all pods with new build are running
  shell: oc get pods -l deployment={{ item.name }}-2 -n test --config={{ mktemp.stdout }}/admin.kubeconfig | tail -n1 | awk '{ print $3 }' | tail -n1
  register: check
  until: check.stdout.find("Running") != -1
  with_items: "{{ pods }}"
  retries: 10
  delay: 20

- name: wait 15 seconds
  wait_for: timeout=15
  delegate_to: localhost
  become: false

- name: connect to route via curl
  command: "curl -v http://{{ item }}/"
  with_items: "{{ pod_hostnames }}"
  register: check_http_route

- name: show route http response
  debug:
    msg: "{{ check_http_route.results | json_query(route_query) }}"

- name: delete test project
  command: oc delete project test --config={{ mktemp.stdout }}/admin.kubeconfig
  register: delete_project
  failed_when: ('deleted' not in delete_project.stdout)
  changed_when: ('deleted' in delete_project.stdout)
